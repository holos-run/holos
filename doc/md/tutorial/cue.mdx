---
slug: cue
title: CUE
description: Render component manifests directly from CUE.
sidebar_position: 50
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';

# CUE

## Overview

This tutorial demonstrates how to add additional resources to a component using
CUE. Holos components often mix in resources, eliminating the need to modify
existing charts or manifests. In this tutorial, we'll add an [ExternalSecret]
resource to the podinfo Helm chart configured in the [Hello Holos] tutorial.

Key concepts:

1. Resources are validated against `#Resources` defined at the root.
2. Custom Resource Definitions need to be imported using Timoni.
3. Helm, Kustomize, and CUE can be mixed together within the same component.

## The Code

### Holos Version

Ensure you have a current version of `holos` installed.  This document was
tested with the following version.

import HolosVersionCommand from '!!raw-loader!./_cue/script-01-holos-version/command.sh';
import HolosVersionOutput from '!!raw-loader!./_cue/script-01-holos-version/output.txt';

<CodeBlock language="bash">{HolosVersionCommand}</CodeBlock>
<CodeBlock language="txt">{HolosVersionOutput}</CodeBlock>

### Generating the Structure

Use `holos` to generate a minimal platform directory structure. First, create
and navigate into a blank directory. Then, use the `holos generate platform`
command to generate a minimal platform.

import MkdirAndInit from '!!raw-loader!./_cue/script-02-cue/mkdir-and-init.sh';

<CodeBlock language="bash">{MkdirAndInit}</CodeBlock>

### Creating the Component

Create the directory for the `podinfo` component. Create an empty file, then add
the following CUE configuration to it.

import MkdirComponents from '!!raw-loader!./_cue/script-02-cue/mkdir-components.sh';
import PodinfoHeader from '!!raw-loader!./_cue/script-02-cue/podinfo-component-header.sh';
import PodinfoBody from '!!raw-loader!./_cue/script-02-cue/podinfo-component-body.cue';
import EofTrailer from '!!raw-loader!./_cue/script-02-cue/eof-trailer.sh';

<CodeBlock language="bash">{PodinfoHeader}</CodeBlock>
<CodeBlock language="cue" showLineNumbers>{PodinfoBody}</CodeBlock>
<CodeBlock language="bash">{EofTrailer}</CodeBlock>

Register the component with the platform.

import RegisterHeader from '!!raw-loader!./_cue/script-02-cue/register-components-header.sh';
import RegisterBody from '!!raw-loader!./_cue/script-02-cue/register-components-body.cue';

<CodeBlock language="bash">{RegisterHeader}</CodeBlock>
<CodeBlock language="cue" showLineNumbers>{RegisterBody}</CodeBlock>
<CodeBlock language="bash">{EofTrailer}</CodeBlock>

Render the platform.

import RenderCommand from '!!raw-loader!./_cue/script-02-cue/render.sh';
import RegisterOutput from '!!raw-loader!./_cue/script-02-cue/register-components-output.txt';

<Tabs groupId="tutorial-hello-render-manifests">
  <TabItem value="command" label="Command">
    <CodeBlock language="bash">{RenderCommand}</CodeBlock>
  </TabItem>
  <TabItem value="output" label="Output">
    <CodeBlock language="txt">{RegisterOutput}</CodeBlock>
  </TabItem>
</Tabs>

Add and commit the initial configuration.

import GitInit from '!!raw-loader!./_cue/script-02-cue/git-init.sh';

<CodeBlock language="bash">{GitInit}</CodeBlock>

### Mixing in Resources

We use the [ComponentConfig] `Resources` field to mix in resources to any
component kind.  This field is a convenient wrapper around the core [BuildPlan]
[Resources] [Generator].

Create the mixins.cue file.

import MixinHeader from '!!raw-loader!./_cue/script-02-cue/mixin-component-header.sh';
import MixinBody from '!!raw-loader!./_cue/script-02-cue/mixin-component-body.cue';

<CodeBlock language="bash">{MixinHeader}</CodeBlock>
<CodeBlock language="cue" showLineNumbers>{MixinBody}</CodeBlock>
<CodeBlock language="bash">{EofTrailer}</CodeBlock>

:::important
Holos uses CUE to validate mixed in resources against a schema.  The `Resources`
field validates against the `#Resources` definition in [resources.cue].
:::

### Importing CRDs

Holos includes CUE schema definitions for the ExternalSecret Custom Resource
Definition (CRD). These schemas are located in the `cue.mod` directory,
generated by the `holos init platform` command executed at the start of this
tutorial.

To import your own custom resource definitions, use [Timoni]. We imported the
ExternalSecret CRDs embedded in `holos` using the following command.

import ImportCRDs from '!!raw-loader!./_cue/script-02-cue/import-crds.sh';
import ImportOutput from '!!raw-loader!./_cue/script-02-cue/timoni-vendor.txt';

<Tabs groupId="35B1A1A1-D7DF-4D27-A575-28556E182096">
  <TabItem value="command" label="Command">
    <CodeBlock language="bash">{ImportCRDs}</CodeBlock>
  </TabItem>
  <TabItem value="output" label="Output">
    <CodeBlock language="txt">{ImportOutput}</CodeBlock>
  </TabItem>
</Tabs>

:::tip
Take a look at
[cue.mod/gen/external-secrets.io/externalsecret/v1beta1/types_gen.cue] to see
the imported definitions.
:::

Once imported, the final step is to add the resource kind to the `#Resources`
struct. Typically, this is done by creating a new file that CUE unifies with the
existing [resources.cue] file.

## Reviewing Changes

Render the platform with the `ExternalSecret` mixed into the podinfo component.

<CodeBlock language="bash">{RenderCommand}</CodeBlock>

Take a look at the diff to see the mixed in `ExternalSecret`.

import GitDiff from '!!raw-loader!./_cue/script-02-cue/git-diff.sh';
import DiffOutput from '!!raw-loader!./_cue/script-02-cue/git.diff';

<CodeBlock language="bash">{GitDiff}</CodeBlock>
<CodeBlock language="diff">{DiffOutput}</CodeBlock>

We saw how to mix in resources using the `Resources` field of the
[ComponentConfig]. This approach works for every kind of component in Holos,
allowing seamless integration without needing to fork the upstream Helm chart.
This way, we can easily update to new podinfo versions as they're released.

## Trying Locally

Optionally, apply the manifests rendered by Holos to a [Local Cluster] for
testing.

## Next Steps

This tutorial uses the `#Resources` structure to map resource kinds to their
schema definitions in CUE. This structure is defined in `resources.cue` at the
root of the tree. Take a look at [resources.cue] to see this mapping structure.

[Local Cluster]: ../topics/local-cluster.mdx
[ExternalSecret]: https://external-secrets.io/latest/api/externalsecret/
[Artifact]: ../api/core.md#Artifact
[Resources]: ../api/core.md#Resources
[Generator]: ../api/core.md#Generator
[Hello Holos]: ./hello-holos.mdx
[cue.mod/gen/external-secrets.io/externalsecret/v1beta1/types_gen.cue]: https://github.com/holos-run/holos/blob/main/internal/generate/platforms/cue.mod/gen/external-secrets.io/externalsecret/v1beta1/types_gen.cue#L13
[ComponentConfig]: ../api/author.md#ComponentConfig
[timoni]: https://timoni.sh/install/
[resources.cue]: https://github.com/holos-run/holos/blob/main/internal/generate/platforms/v1alpha5/resources.cue#L33
