name: Publish

on:
  push:
    branches: ['main', 'publish']

jobs:
  publish:
    name: Publish
    runs-on: gha-rs
    steps:
      - name: Provide GPG and Git
        run: sudo apt update && sudo apt -qq -y install gnupg git curl zip unzip tar bzip2 make

      # Must come after git executable is provided
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version: '1.22.x'

      - uses: ko-build/setup-ko@v0.7
        env:
          KO_DOCKER_REPO: quay.io/holos-run/holos

      - name: Publish
        env:
          KO_DOCKER_REPO: quay.io/holos-run/holos
          auth_token: ${{ secrets.QUAY_TOKEN }}
          auth_user: ${{ secrets.QUAY_USER }}
        run: |
          echo "${auth_token}" | ko login "https://${KO_DOCKER_REPO}" --username "${auth_user}" --password-stdin
          ko build
